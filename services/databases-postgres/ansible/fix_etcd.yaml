---
- name: Force Install Etcd via Binary (HTTP Mode)
  hosts: databases
  become: yes
  vars:
    etcd_version: "v3.5.12"
  tasks:
    - name: Download and Unpack
      get_url:
        url: "https://github.com/etcd-io/etcd/releases/download/{{ etcd_version }}/etcd-{{ etcd_version }}-linux-amd64.tar.gz"
        dest: /tmp/etcd.tar.gz

    - name: Unpack etcd
      unarchive:
        src: /tmp/etcd.tar.gz
        dest: /tmp/
        remote_src: yes

    - name: Move binaries
      copy:
        src: "/tmp/etcd-{{ etcd_version }}-linux-amd64/{{ item }}"
        dest: "/usr/bin/{{ item }}"
        mode: '0755'
        remote_src: yes
      loop: [etcd, etcdctl]

    - name: Ensure etcd user/group
      group:
        name: etcd
        state: present
    - user:
        name: etcd
        group: etcd
        shell: /bin/false
        system: yes

    - name: STOP and PURGE etcd
      shell: |
        systemctl stop etcd || true
        rm -rf /var/lib/etcd
        mkdir -p /var/lib/etcd
        chown -R etcd:etcd /var/lib/etcd
        chmod 700 /var/lib/etcd

    - name: Deploy etcd Systemd Unit
      copy:
        dest: /etc/systemd/system/etcd.service
        content: |
          [Unit]
          Description=etcd - highly-available key value store
          After=network.target

          [Service]
          Type=notify
          User=etcd
          ExecStart=/usr/bin/etcd \
            --name {{ inventory_hostname }} \
            --data-dir /var/lib/etcd \
            --initial-advertise-peer-urls http://{{ ansible_default_ipv4.address }}:2380 \
            --listen-peer-urls http://{{ ansible_default_ipv4.address }}:2380 \
            --listen-client-urls http://{{ ansible_default_ipv4.address }}:2379,http://127.0.0.1:2379 \
            --advertise-client-urls http://{{ ansible_default_ipv4.address }}:2379 \
            --initial-cluster postgres-01=http://10.10.10.201:2380,postgres-02=http://10.10.10.202:2380,postgres-03=http://10.10.10.203:2380 \
            --initial-cluster-state new \
            --initial-cluster-token etcd-cluster-1
          Restart=on-failure
          RestartSec=5

          [Install]
          WantedBy=multi-user.target

    - name: Reload and Start
      systemd:
        name: etcd
        state: restarted
        enabled: yes
        daemon_reload: yes