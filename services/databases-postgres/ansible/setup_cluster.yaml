---
- name: Bootstrap PostgreSQL 18 Cluster Nodes
  hosts: databases
  become: yes
  vars:
    postgres_password: {{ postgres_password }}
    replication_password: {{ replication_password }}
    etcd_settings:
      protocol: http
      endpoints: ['10.10.10.201:2379', '10.10.10.202:2379', '10.10.10.203:2379']

    cluster_settings:
      postgresql:
        parameters:
          password_encryption: scram-sha-256
          shared_preload_libraries: pglogical
          ssl: 'off'
          wal_level: logical
          max_connections: 100
          shared_buffers: "2GB"
        pg_hba:
          - local   all             all                                     trust
          - host    replication     replicator      127.0.0.1/32            scram-sha-256
          - host    replication     replicator      10.10.10.0/24           scram-sha-256
          - host    all             all             100.64.0.0/10           scram-sha-256
          - host    all             all             10.10.10.0/24           scram-sha-256
          - host    all             all             127.0.0.1/32            scram-sha-256
          - host    all             postgres        0.0.0.0/0               scram-sha-256

  tasks:
    - name: Install dependencies
      apt:
        name: 
          - curl
          - ca-certificates
          - gnupg
          - python3-psycopg2
          - patroni
          - postgresql-18
          - postgresql-18-pglogical
        state: present
        update_cache: yes

    - name: Stop default Postgres (so Patroni can own 5432)
      systemd:
        name: postgresql
        state: stopped
        enabled: no

    - name: Remove default Postgres cluster to prevent conflicts
      command: pg_dropcluster 18 main --stop
      ignore_errors: yes

    - name: Create Patroni config directory
      file:
        path: /etc/patroni
        state: directory
        owner: postgres
        group: postgres
        mode: '0755'

    - name: Deploy Patroni Config from Template
      template:
        src: templates/patroni.yml.j2
        dest: /etc/patroni/config.yml
        owner: postgres
        group: postgres
        mode: '0644'
      notify: restart patroni

    - name: Ensure Patroni is started and enabled
      systemd:
        name: patroni
        state: started
        enabled: yes

  handlers:
    - name: restart patroni
      systemd:
        name: patroni
        state: restarted