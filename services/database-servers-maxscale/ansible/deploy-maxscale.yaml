---
# PLAY 1: Fix Permissions on the MariaDB Master
- name: Prepare MariaDB Permissions
  hosts: mariadb_master
  become: yes
  vars_files:
    - "../../../ansible/group_vars/all/vars.yml"
    - "../../../ansible/group_vars/all/vault.yml"
  tasks:
    - name: Ensure DB server has python3-pymysql
      apt:
        name: python3-pymysql
        state: present

    - name: Configure pacs user on Master (Will replicate to slaves)
      community.mysql.mysql_user:
        login_unix_socket: /var/run/mysqld/mysqld.sock
        name: "pacs"
        host: "10.10.10.%"
        password: "{{ pacsdb_password }}"
        priv: "*.*:SELECT,REPLICATION CLIENT,SLAVE MONITOR,REPLICATION SLAVE ADMIN"
        state: present

# PLAY 2: Configure MaxScale HA Cluster
- name: Configure MaxScale HA Cluster
  hosts: maxscale
  become: yes
  vars_files:
    - "../../../ansible/group_vars/all/vars.yml"
    - "../../../ansible/group_vars/all/vault.yml"

  tasks:
    - name: Wait for Cloud-Init / Apt lock
      shell: while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 5; done
      changed_when: false

    - name: Install MariaDB Repo
      shell: curl -LsS https://r.mariadb.com/downloads/mariadb_repo_setup | bash -s -- --mariadb-maxscale-version=23.08
      args:
        creates: /etc/apt/sources.list.d/mariadb.list

    - name: Install Packages
      apt:
        name: [maxscale, keepalived, psmisc, python3-pymysql]
        state: present
        update_cache: yes

    - name: Deploy MaxScale Config
      template:
        src: templates/maxscale.cnf.j2
        dest: /etc/maxscale.cnf
        mode: '0644'
      notify: Restart MaxScale

    - name: Deploy Keepalived Config
      template:
        src: templates/keepalived.conf.j2
        dest: /etc/keepalived/keepalived.conf
        mode: '0644'
      notify: Restart Keepalived

    - name: Flush handlers
      meta: flush_handlers

    - name: Wait for VIP stabilization
      pause:
        seconds: 10

  handlers:
    - name: Restart MaxScale
      service: name=maxscale state=restarted enabled=yes
    - name: Restart Keepalived
      service: name=keepalived state=restarted enabled=yes

# PLAY 3: Install Client and Verify on MaxScale Nodes
- name: Prepare MaxScale Nodes as Clients and Verify
  hosts: maxscale
  become: yes
  vars_files:
    - "../../../ansible/group_vars/all/vars.yml"
    - "../../../ansible/group_vars/all/vault.yml"

  tasks:
    - name: Install MariaDB Client
      apt:
        name: mariadb-client
        state: present
        update_cache: yes

    - name: Verify VIP Connectivity and Load Balancing (Trying to hit a Slave)
      shell: "mariadb -h {{ vrrp_vip }} -u pacs -p'{{ pacsdb_password }}' --ssl=0 -e 'SELECT @@hostname;'"
      register: db_check
      retries: 10
      delay: 5
      until: db_check is succeeded
      changed_when: false

    - name: Show Final Status
      debug:
        msg: "Success! Node {{ inventory_hostname }} verified VIP {{ vrrp_vip }} is routing to: {{ db_check.stdout_lines[-1] }}"